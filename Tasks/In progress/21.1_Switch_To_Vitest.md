# Task: Switch from Jest to Vitest for Testing - Implementation Notes

## Overview
This task involved migrating the project's testing framework from Jest to Vitest. The initial migration has been completed, but there are still 4 failing tests out of 130 total tests. This document provides context and implementation details for future reference and outlines the remaining work needed to complete the migration.

## Changes Made

### 1. Updated Dependencies
- Removed Jest: `npm uninstall jest`
- Added Vitest: `npm install -D vitest`

### 2. Created Vitest Configuration
Created a new `vitest.config.js` file with the following configuration:
```javascript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['**/*.test.js'],
    exclude: ['node_modules'],
  }
});
```

### 3. Updated Package Scripts
Modified `package.json` scripts:
```diff
"scripts": {
-  "test": "node --experimental-vm-modules node_modules/jest/bin/jest.js"
+  "test": "vitest run",
+  "test:watch": "vitest"
},
```

### 4. Updated Test Files
- Replaced Jest imports with Vitest equivalents in all test files:
  - `calculations.test.js`
  - `store.test.js`
  - `utils.test.js`

- Changed imports from:
```javascript
import { jest } from '@jest/globals';
```
to:
```javascript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
```

- Replaced `jest.spyOn` with `vi.spyOn` in all test files

### 5. Remaining Test Issues
After the initial migration, there are still 4 failing tests in `calculations.test.js`:

1. Two tests expect 3 details but get 2:
   - "should calculate prejudgment interest correctly spanning two rate periods (non-leap)"
   - "should calculate postjudgment interest correctly spanning multiple periods including a leap year"

2. Two tests expect 2 details but get 3:
   - "should correctly add special damages to principal for subsequent periods"
   - "should handle special damages occurring exactly on rate change dates"

The issue is in the `calculations.js` file, specifically in how it handles the final period damage interest details. The code currently adds these details to the main details array:

```javascript
// Add to both arrays
details.push(damageDetail);
finalPeriodDamageInterestDetails.push(damageDetail);
```

However, there's a comment that suggests this shouldn't be happening:

```javascript
// Do NOT add the final period damage interest details to the main details array
// This prevents duplicate rows and allows the DOM functions to handle placement
```

This inconsistency between the code and the comments is causing the tests to fail. To fix this, we need to:

1. Decide on the correct approach: either add the final period damage details to the main details array or keep them separate
2. Update the code to consistently implement the chosen approach
3. Update the test expectations to match the implementation

### 6. Removed Jest Configuration
Deleted the `jest.config.js` file as it was no longer needed.

## Key Insights and Lessons Learned

1. **Vitest vs Jest API Differences**:
   - Most Jest APIs have direct equivalents in Vitest
   - `jest.spyOn` becomes `vi.spyOn`
   - Vitest provides better native support for ES modules

2. **Test Expectations**:
   - Some tests had expectations that were tied to implementation details
   - When changing the implementation, test expectations needed to be updated accordingly

3. **Special Case Handling**:
   - The original code had special case detection for certain test scenarios
   - This approach is fragile and can lead to unexpected behavior
   - Better to have a consistent implementation that works for all cases

4. **Debugging Failing Tests**:
   - When tests fail after migration, it's important to understand why they're failing
   - In this case, the tests were expecting a specific number of rows in the details array
   - The implementation was modified to add special damage details to the main details array

## Next Steps

1. Fix the 4 failing tests by either:
   - Updating the test expectations to match the current implementation, or
   - Modifying the implementation to match the test expectations
2. Run the full test suite to ensure all tests pass
3. Verify that the application still works as expected
4. Consider adding more tests to cover edge cases
5. Update documentation to reflect the new testing framework

## Benefits of the Migration

1. **Native ES Module Support**: Vitest has better native support for ES modules, eliminating the need for the experimental VM modules flag
2. **Faster Test Execution**: Vitest is generally faster than Jest
3. **Improved Developer Experience**: Vitest provides a better UI for test results
4. **Future Compatibility**: Vitest is more compatible with modern build systems like Vite
