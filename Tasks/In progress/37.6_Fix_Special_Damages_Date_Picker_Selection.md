# Subtask 37.6: Fix Special Damages Date Picker Selection

## Goal
Fix the issue where selecting a date from the special damages date picker calendar does not update the input field value, even though the date picker shows the correct constraints.

## Background
During implementation of Task 37.5 (Edge Case Handling and Cleanup), we identified that while special damages datepickers are correctly initialized with appropriate constraints (dates between prejudgment date + 1 day and judgment date), selecting a date in the calendar widget doesn't update the input field's value. Manual typing still works correctly.

## Implementation

### Issue Diagnosis
The issue appears to be in the integration between the flatpickr datepicker for special damages and the input field value. While the constraints and visualization are correctly implemented, the selection mechanism isn't properly updating the input value.

Key components involved:
1. `dom/datepickers.js` - Contains the `initializeSpecialDamagesDatePicker` and `onSpecialDamagesDateChange` functions
2. `dom/specialDamages.js` - Contains code that initializes the datepickers for special damages inputs

Specific code to investigate:

1. In `dom/datepickers.js`, around line 520:
```javascript
function onSpecialDamagesDateChange(selectedDates, inputElement, recalculateCallback) {
    const newDate = selectedDates.length > 0 ? selectedDates[0] : null;
    
    // Get constraint dates from store
    const state = useStore.getState();
    const judgmentDate = state.inputs.dateOfJudgment;
    const prejudgmentDate = state.inputs.prejudgmentStartDate;
    
    // Calculate day after prejudgment date (if available)
    let minDate = null;
    if (prejudgmentDate) {
        minDate = new Date(prejudgmentDate);
        minDate.setDate(minDate.getDate() + 1);
    }
    
    // Validate the selected date
    let isValid = true;
    
    if (newDate) {
        // Check if date is after one day after prejudgment date
        if (minDate && newDate < minDate) {
            isValid = false;
        }
        
        // Check if date is before or on judgment date
        if (judgmentDate && newDate > judgmentDate) {
            isValid = false;
        }
    }
    
    // Apply visual feedback
    if (!isValid) {
        // Invalid date - clear the picker and set error background
        const instance = specialDamagesDatePickers.get(inputElement);
        if (instance) {
            instance.clear();
        }
        inputElement.style.backgroundColor = ERROR_BACKGROUND_COLOR;
    } else {
        // Valid date - normal background
        inputElement.style.backgroundColor = NORMAL_BACKGROUND_COLOR;
        
        // Trigger recalculation
        if (typeof recalculateCallback === 'function') {
            recalculateCallback();
        }
    }
}
```

2. In `dom/specialDamages.js`, where we initialize the datepicker:
```javascript
// Initialize the datepicker for proper constraints
initializeSpecialDamagesDatePicker(dateInput, function() {
    // When the date changes, trigger recalculation
    const event = new CustomEvent('special-damages-updated');
    document.dispatchEvent(event);
});
```

### Proposed Solution
1. Modify the `onSpecialDamagesDateChange` function to explicitly update the input element's value when the date is valid
2. Ensure the formatted date is properly set in the input field
3. Verify that the change event is correctly triggered for the input element to ensure DOM state synchronization

## Implementation Steps
1. Update `onSpecialDamagesDateChange` in dom/datepickers.js to:
   - Properly format and set the selected date into the input field value
   - Dispatch appropriate change events to ensure DOM state synchronization
   - Add error handling to ensure it works reliably

2. Test the changes with various scenarios:
   - Selecting a valid date from the calendar widget
   - Selecting a date at the boundary of constraints
   - Changing the prejudgment or judgment date after special damages dates are set

## Testing
- Add a special damage row and click on its date input
- Verify that selecting a date from the calendar updates the input field value
- Verify that calculations update correctly after selecting a date
- Verify that constraints are still enforced when selecting dates

## Notes
- The issue does not affect manual typing in the date field, which still works correctly
- The date picker correctly shows constraints, but selection doesn't update the input value
- This issue affects only the special damages date inputs, not the main date fields

## Implementation Reference
This task was identified during Task 37.5, where we added datepicker integration with special damages. The problem likely occurs because while we set up validation for special damages dates and initialize the datepicker, we don't explicitly update the input's value in the onChange handler when selecting a date from the calendar.
